#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

sudo chmod 777 /tmp

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
# parse args
BUILD_DIR=$1
CACHE_DIR=$2
LOGGER_FLAGS=""
BUILDPACK_DIR="$(dirname ${BIN_DIR})"
CORES="/solr-home/cores"

echo '==> Render dynamic config files'
for template in $(find $1/ | grep '.erb$')
do
  target=$(dirname "${template}")/$(basename -s .erb "${template}")
  echo "$template -> $target"
  erb "${template}" > "${target}"
done

echo '==> Layout Solr'
#miles of files!
cp -R ${BUILDPACK_DIR}/overlay/* ${HOME}/
mkdir -p ${HOME}/solr-home
cp -R ${BUILD_DIR}/* ${HOME}/solr-home/

if which java; then
  :
else
  echo '==> Installing Oracle Java 1.7'
  #Custom repo for Java 1.7
  sudo apt-get install -y software-properties-common
  sudo add-apt-repository -y ppa:webupd8team/java
  sudo apt-get -y -qq update
  sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys EEA14886
  #Auto accept installer prompts
  echo debconf shared/accepted-oracle-license-v1-1 select true | sudo debconf-set-selections
  echo debconf shared/accepted-oracle-license-v1-1 seen true | sudo debconf-set-selections
  echo oracle-java7-installer shared/accepted-oracle-license-v1-1 select true | sudo /usr/bin/debconf-set-selections
  ##install
  sudo apt-get install -y oracle-java7-installer
  sudo apt-get install oracle-java7-set-default
fi
