#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

sudo chmod 777 /tmp

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
# parse args
BUILD_DIR=$1
CACHE_DIR=$2
LOGGER_FLAGS=""
BUILDPACK_DIR="$(dirname ${BIN_DIR})"
CORES="/solr-home/cores"

echo '==> Render dynamic config files'
for template in $(find $BUILD_DIR/ | grep '.erb$')
do
  target=$(dirname "${template}")/$(basename -s .erb "${template}")
  echo "$template -> $target"
  erb "${template}" > "${target}"
done

echo '==> Layout Solr'
#miles of files!
cp -R ${BUILDPACK_DIR}/overlay/* ${HOME}/
mkdir -p ${HOME}/solr-home
cp -R ${BUILD_DIR}/* ${HOME}/solr-home/

if which java; then
  :
else
  echo '==> Installing Oracle Java 1.8'
  sudo apt-get install -y software-properties-common
  sudo add-apt-repository --yes ppa:webupd8team/java
  sudo apt-get --yes update
  #Auto accept installer prompts
  echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | sudo /usr/bin/debconf-set-selections
  ##install
  sudo apt-get install --yes oracle-java8-installer
  sudo apt-get install --yes oracle-java8-set-default
fi
